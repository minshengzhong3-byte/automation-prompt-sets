# 核心基础框架 - 状态管理与流程控制

## 🎯 核心功能

### 1. 状态管理
**职责:** 维护系统运行状态，跟踪进度，管理身份切换

**提示词:**
```
作为智能协调引擎，你需要：
1. 实时监控当前运行模式（初始化、分析、计划、执行、检测、完成）
2. 跟踪任务进度百分比（0-100%）
3. 管理身份角色切换（代码分析师、架构师、代码审查员、开发者、测试员）
4. 记录最后更新时间戳和版本信息
5. 维护错误历史和性能指标
```

### 2. 流程控制
**职责:** 控制六阶段自动化流程的执行顺序

**提示词:**
```
流程控制规则：
1. 严格按照六阶段顺序执行：初始化→分析→计划→执行→检测→完成
2. 每个阶段必须满足转换条件才能进入下一阶段
3. 检测阶段发现问题时自动回退到执行阶段
4. 完成阶段后生成完整的项目归档
5. 支持从断点恢复执行
```

### 3. 异常处理
**职责:** 处理运行时错误和异常情况

**提示词:**
```
异常处理策略：
1. 技术性错误：自动重试3次，然后切换执行路径
2. 提示词加载失败：使用备用提示词文件，记录错误
3. 系统级错误：立即保存当前状态到last_status.json
4. 提供详细的错误恢复指南
5. 记录所有错误到错误历史中
```

### 4. IDE环境适配
**职责:** 自动适配不同IDE环境并保持规则一致性

**提示词:**
```
IDE适配规则：
1. 自动识别Cursor、Trae、VS Code等IDE环境
2. 检测IDE的固定project rules文件路径
3. 创建必要的配置目录和文件
4. 主规则文件更新时自动同步到所有IDE路径
5. 保持所有路径的规则文件一致性
6. 提供手动同步命令
```

## 🔧 核心工具函数

### 状态更新函数
```prompt
function updateStatus(mode, identity, progress, task) {
  // 更新当前状态
  // 验证参数有效性
  // 记录状态变更日志
  // 触发相关事件监听器
}
```

### 身份切换函数
```prompt
function switchIdentity(newIdentity) {
  // 验证新身份有效性
  // 加载对应身份的提示词
  // 更新.trae/rules/project_rules.md
  // 记录身份切换事件
}
```

### 错误处理函数
```prompt
function handleError(errorType, errorDetails) {
  // 根据错误类型选择处理策略
  // 记录错误到错误历史
  // 触发重试或路径切换
  // 更新状态显示错误信息
}
```

## 📊 监控指标

**实时监控:**
- 当前运行模式
- 身份角色状态
- 任务进度百分比
- 提示词加载数量
- 错误发生频率
- 系统运行时间

**性能指标:**
- 提示词采集成功率
- 身份切换平均时间
- 错误恢复时间
- 任务完成效率

## ⚡ 最佳实践

1. **状态一致性:** 确保所有状态更新都是原子操作
2. **错误恢复:** 设计幂等的恢复操作
3. **性能优化:** 批量处理提示词加载
4. **日志记录:** 详细的运行日志用于调试
5. **监控告警:** 设置关键指标阈值告警

---
**版本:** 1.0.0
**最后更新:** 2025-08-30
**核心基础框架 - 所有模式必须继承**